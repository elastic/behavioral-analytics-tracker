{"version":3,"sources":["../src/index.ts","../../core/src/dataproviders/event-type.ts","../../core/src/dataproviders/page-referrer.ts","../../core/src/dataproviders/page-url.ts","../../core/src/util/cookies.ts","../../core/src/util/uuid.ts","../../core/src/util/session.ts","../../core/src/dataproviders/user-uuid.ts","../../core/src/dataproviders/index.ts","../../core/src/tracker.ts","../src/util/script-attribute.ts"],"sourcesContent":["import { Tracker } from \"@elastic/behavioural-analytics-tracker-core\";\nimport { getScriptAttribute } from \"./util/script-attribute\";\n\nconst dsn = getScriptAttribute(\"data-dsn\");\nif (!dsn)\n  throw new Error(\n    \"Behavioural Analytics: Missing DSN. Please refer to the integration guide.\"\n  );\nconst tracker = new Tracker({ dsn });\n\nconst trackPageView = () => tracker.trackPageView();\n\nwindow.addEventListener(\"pageshow\", trackPageView);\n\nif (window.history) {\n  const pushState = window.history.pushState;\n  window.history.pushState = (...args) => {\n    window.dispatchEvent(new Event(\"ewt:pushstate\"));\n    return pushState.apply(window.history, args);\n  };\n  window.addEventListener(\"ewt:pushstate\", trackPageView);\n  window.addEventListener(\"popstate\", trackPageView);\n} else {\n  window.addEventListener(\"hashchange\", trackPageView);\n}\n\nexport default tracker;\n","import { TrackerEventProperties, TrackerEventType } from \"../types\";\n\nexport default (\n  eventType: TrackerEventType,\n  properties: TrackerEventProperties\n) => {\n  return { ...properties, event_type: eventType };\n};\n","import { TrackerEventProperties, TrackerEventType } from \"../types\";\n\nexport default (\n  eventType: TrackerEventType,\n  properties: TrackerEventProperties\n) => {\n  if (eventType !== \"pageview\" || !document.referrer) {\n    return properties;\n  }\n\n  return { ...properties, referrer: document.referrer };\n};\n","import { TrackerEventProperties, TrackerEventType } from \"../types\";\n\nexport default (\n  eventType: TrackerEventType,\n  properties: TrackerEventProperties\n) => {\n  if (eventType !== \"pageview\") {\n    return properties;\n  }\n\n  return { ...properties, url: window.location.href };\n};\n","export function getCookie(name: string) {\n  const value = \"; \" + document.cookie;\n  const parts = value.split(\"; \" + name + \"=\");\n\n  if (parts.length === 2 && parts[1]) {\n    return parts.pop()?.split(\";\").shift();\n  }\n}\n\nexport function setCookie(\n  cookieName: string,\n  cookieValue: string,\n  expiresAt: Date,\n  path: string = \"/\"\n) {\n  var expires = \"expires=\" + expiresAt.toUTCString();\n  document.cookie =\n    cookieName + \"=\" + cookieValue + \"; \" + expires + \"; path=\" + path;\n}\n","export function uuidv4() {\n  // @ts-ignore\n  return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, function (c) {\n    return (\n      c ^\n      (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))\n    ).toString(16);\n  });\n}\n","import { getCookie, setCookie } from './cookies';\nimport { uuidv4 } from './uuid';\n\n\nexport function visitorId() {\n  const visitorId = getCookie('EA_VID') || uuidv4();\n\n  const expiresAt = new Date();\n  expiresAt.setHours(23, 59, 59, 999);\n  setCookie('EA_VID', visitorId, expiresAt);\n\n  return visitorId;\n};\n","import { TrackerEventProperties, TrackerEventType } from \"../types\";\nimport { visitorId } from \"../util/session\";\n\nexport default (\n  eventType: TrackerEventType,\n  properties: TrackerEventProperties\n) => {\n  return { ...properties, user_uuid: visitorId() };\n};\n","import eventType from './event-type';\nimport pageReferrer from './page-referrer';\nimport pageUrl from './page-url';\nimport userUuid from './user-uuid';\n\nexport {\n  eventType,\n  pageReferrer,\n  pageUrl,\n  userUuid\n};\n\nexport const DEFAULT_DATA_PROVIDERS = {\n  eventType,\n  pageReferrer,\n  pageUrl,\n  userUuid\n}\n","import { DEFAULT_DATA_PROVIDERS } from \"./dataproviders\";\nimport {\n  TrackerEvent,\n  TrackerEventProperties,\n  TrackerEventType,\n  DataProvider,\n  TrackerOptions,\n} from \"./types\";\n\nexport const processEvent = (\n  eventType: TrackerEventType,\n  properties: TrackerEventProperties,\n  dataProviders: Record<string, DataProvider>\n) => {\n  return Object.values(dataProviders).reduce<TrackerEventProperties>(\n    (props, dataProvider) => {\n      return dataProvider(eventType, props);\n    },\n    { event_data: properties }\n  ) as TrackerEvent;\n};\n\nexport class Tracker {\n  private dataProviders: Record<string, DataProvider>;\n  private endpointURL: string;\n\n  constructor(options: TrackerOptions) {\n    this.endpointURL = options.dsn;\n    this.dataProviders = {\n      ...DEFAULT_DATA_PROVIDERS,\n      ...(options.dataProviders || {}),\n    };\n  }\n\n  trackEvent(\n    eventType: TrackerEventType,\n    properties: TrackerEventProperties = {}\n  ) {\n    const eventData = processEvent(eventType, properties, this.dataProviders);\n\n    const encodedPayload = JSON.stringify(eventData);\n    const eventTrackerURL = `${this.endpointURL}/events`;\n\n    if (navigator.sendBeacon != null) {\n      navigator.sendBeacon(eventTrackerURL, encodedPayload);\n    } else {\n      const xhr = new XMLHttpRequest();\n      xhr.open(\"POST\", eventTrackerURL, true);\n      xhr.setRequestHeader(\"Content-Type\", \"text/plain\");\n\n      xhr.send(encodedPayload);\n    }\n  }\n\n  trackPageView(properties?: TrackerEventProperties) {\n    this.trackEvent(\"pageview\", properties);\n  }\n}\n","export function getScriptAttribute(attributeName: string) {\n  const scriptElement = document.currentScript;\n  return scriptElement?.getAttribute(attributeName);\n}\n"],"mappings":"2cAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,aAAAE,ICEA,IAAOC,EAAQ,CACbC,EACAC,KAEO,CAAE,GAAGA,EAAY,WAAYD,CAAU,GCJhD,IAAOE,EAAQ,CACbC,EACAC,IAEID,IAAc,YAAc,CAAC,SAAS,SACjCC,EAGF,CAAE,GAAGA,EAAY,SAAU,SAAS,QAAS,ECRtD,IAAOC,EAAQ,CACbC,EACAC,IAEID,IAAc,WACTC,EAGF,CAAE,GAAGA,EAAY,IAAK,OAAO,SAAS,IAAK,ECV7C,SAASC,EAAUC,EAAc,CAAxC,IAAAC,EAEE,IAAMC,GADQ,KAAO,SAAS,QACV,MAAM,KAAOF,EAAO,GAAG,EAE3C,GAAIE,EAAM,SAAW,GAAKA,EAAM,GAC9B,OAAOD,EAAAC,EAAM,IAAI,IAAV,YAAAD,EAAa,MAAM,KAAK,OAEnC,CAEO,SAASE,EACdC,EACAC,EACAC,EACAC,EAAe,IACf,CACA,IAAIC,EAAU,WAAaF,EAAU,YAAY,EACjD,SAAS,OACPF,EAAa,IAAMC,EAAc,KAAOG,EAAU,UAAYD,CAClE,CClBO,SAASE,GAAS,CAEvB,OAAQ,CAAC,GAAG,EAAI,KAAO,KAAO,KAAO,OAAO,QAAQ,SAAU,SAAUC,EAAG,CACzE,OACEA,EACC,OAAO,gBAAgB,IAAI,WAAW,CAAC,CAAC,EAAE,GAAM,IAAOA,EAAI,GAC5D,SAAS,EAAE,CACf,CAAC,CACH,CCJO,SAASC,GAAY,CAC1B,IAAMA,EAAYC,EAAU,QAAQ,GAAKC,EAAO,EAE1CC,EAAY,IAAI,KACtB,OAAAA,EAAU,SAAS,GAAI,GAAI,GAAI,GAAG,EAClCC,EAAU,SAAUJ,EAAWG,CAAS,EAEjCH,CACT,CCTA,IAAOK,EAAQ,CACbC,EACAC,KAEO,CAAE,GAAGA,EAAY,UAAWC,EAAU,CAAE,GCK1C,IAAMC,EAAyB,CACpC,UAAAC,EACA,aAAAC,EACA,QAAAC,EACA,SAAAC,CACF,ECRO,IAAMC,EAAe,CAC1BC,EACAC,EACAC,IAEO,OAAO,OAAOA,CAAa,EAAE,OAClC,CAACC,EAAOC,IACCA,EAAaJ,EAAWG,CAAK,EAEtC,CAAE,WAAYF,CAAW,CAC3B,EAGWI,EAAN,KAAc,CAInB,YAAYC,EAAyB,CACnC,KAAK,YAAcA,EAAQ,IAC3B,KAAK,cAAgB,CACnB,GAAGC,EACH,GAAID,EAAQ,eAAiB,CAAC,CAChC,CACF,CAEA,WACEN,EACAC,EAAqC,CAAC,EACtC,CACA,IAAMO,EAAYT,EAAaC,EAAWC,EAAY,KAAK,aAAa,EAElEQ,EAAiB,KAAK,UAAUD,CAAS,EACzCE,EAAkB,GAAG,KAAK,qBAEhC,GAAI,UAAU,YAAc,KAC1B,UAAU,WAAWA,EAAiBD,CAAc,MAC/C,CACL,IAAME,EAAM,IAAI,eAChBA,EAAI,KAAK,OAAQD,EAAiB,EAAI,EACtCC,EAAI,iBAAiB,eAAgB,YAAY,EAEjDA,EAAI,KAAKF,CAAc,CACzB,CACF,CAEA,cAAcR,EAAqC,CACjD,KAAK,WAAW,WAAYA,CAAU,CACxC,CACF,ECzDO,SAASW,EAAmBC,EAAuB,CACxD,IAAMC,EAAgB,SAAS,cAC/B,OAAOA,GAAA,YAAAA,EAAe,aAAaD,EACrC,CVAA,IAAME,EAAMC,EAAmB,UAAU,EACzC,GAAI,CAACD,EACH,MAAM,IAAI,MACR,4EACF,EACF,IAAME,EAAU,IAAIC,EAAQ,CAAE,IAAAH,CAAI,CAAC,EAE7BI,EAAgB,IAAMF,EAAQ,cAAc,EAElD,OAAO,iBAAiB,WAAYE,CAAa,EAEjD,GAAI,OAAO,QAAS,CAClB,IAAMC,EAAY,OAAO,QAAQ,UACjC,OAAO,QAAQ,UAAY,IAAIC,KAC7B,OAAO,cAAc,IAAI,MAAM,eAAe,CAAC,EACxCD,EAAU,MAAM,OAAO,QAASC,CAAI,GAE7C,OAAO,iBAAiB,gBAAiBF,CAAa,EACtD,OAAO,iBAAiB,WAAYA,CAAa,CACnD,MACE,OAAO,iBAAiB,aAAcA,CAAa,EAGrD,IAAOG,EAAQL","names":["src_exports","__export","src_default","event_type_default","eventType","properties","page_referrer_default","eventType","properties","page_url_default","eventType","properties","getCookie","name","_a","parts","setCookie","cookieName","cookieValue","expiresAt","path","expires","uuidv4","c","visitorId","getCookie","uuidv4","expiresAt","setCookie","user_uuid_default","eventType","properties","visitorId","DEFAULT_DATA_PROVIDERS","event_type_default","page_referrer_default","page_url_default","user_uuid_default","processEvent","eventType","properties","dataProviders","props","dataProvider","Tracker","options","DEFAULT_DATA_PROVIDERS","eventData","encodedPayload","eventTrackerURL","xhr","getScriptAttribute","attributeName","scriptElement","dsn","getScriptAttribute","tracker","Tracker","trackPageView","pushState","args","src_default"]}